@page "/ferieboliger/{Id:int}"

@using Ferieboliger.BLL.Services;
@using Ferieboliger.Pages.Feriebolig.EditModuler;
@using Ferieboliger.Pages.Feriebolig.Booking;
@using System.Globalization;
@using BlazorInputFile;
@using System.IO;
@using System;
@using Ferieboliger.DAL.Models.Enums;

@inject ISnackbar Snackbar
@inject IFerieboligService ferieboligService;
@inject IFacilitetService facilitetService;
@inject IFiloplysningerService filoplysningerService;
@inject IHelperService helperService;

<MudPaper Width="100%" Elevation="0" Class="d-flex">
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge">
        <MudPaper Elevation="0">
            <MudText>
                <h3>@feriebolig.Adresse.By hus nr. @feriebolig.Id</h3>
                <p>
                    @feriebolig.Adresse.Vej, @feriebolig.Adresse.Postnummer @feriebolig.Adresse.By<br />
                    @feriebolig.Adresse.Land
                </p>
            </MudText>

            @if (_source.Count() > 0)
            {
                <MudCarousel PreviousIcon="" Class="feriebolig__karrusel" @ref="_carousel" ItemsSource="@_source" Style="height: 35rem;" ShowArrows="@_arrows" ShowDelimiters="@_delimiters" AutoCycle="@_autocycle">
                    <ItemTemplate>
                        <div class="d-flex flex-column flex-column justify-center feriebolig__billeder" style="height:100%; background-image:url(@context)">

                        </div>
                    </ItemTemplate>
                </MudCarousel>
            }

            <br />
            <Microsoft.AspNetCore.Components.Forms.InputFile id="uploadFiles" hidden multiple OnChange="HandleFileSelected" accept=".jpg, .jpeg, .png">

            </Microsoft.AspNetCore.Components.Forms.InputFile>

            @if (uploadFiltype)
            {
                <MudText Typo="Typo.body2" Color="Color.Error">@fejlbesked</MudText>
            }

            <MudButton HtmlTag="label"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Filled.CloudUpload"
                       for="uploadFiles">
                Vælg billeder
            </MudButton>

            @if (upload)
            {
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="UploadImages">Upload</MudButton>
            }

            @if (files != null)
            {
                <MudText Typo="@Typo.h6">@files.Count() File@(files.Count() == 1 ? "" : "s"):</MudText>
                <MudList>
                    @foreach (var file in files)
                    {
                        <MudListItem Icon="@Icons.Filled.AttachFile" @key="@file">
                            @file.Name <code>@file.Size bytes</code>
                        </MudListItem>
                    }
                </MudList>
            }

            @if (!upload && _source.Count() > 0)
            {
                <MudButton Class="ma-2" Variant="Variant.Filled" Color="Color.Error" OnClick="@(async () => await DeleteAsync(_carousel.SelectedIndex))">Slet</MudButton>
            }


            <MudCard Elevation="0" Class="d-flex feriebolig__highlights">
                <EditHighlights Overskrift="Highlights" Model="@feriebolig"></EditHighlights>
            </MudCard>

            <MudCard Elevation="0" Class="feriebolig__rediger">
                <EditTextfields Model="@feriebolig" Overskrift="Beskrivelse" Property="@feriebolig.Beskrivelse" PropertyName="Beskrivelse"></EditTextfields>
            </MudCard>
            <MudCard Elevation="0" Class="feriebolig__rediger">
                <EditTextfields Model="@feriebolig" Overskrift="Bemærkninger" Property="@feriebolig.Bemaerkninger" PropertyName="Bemaerkninger"></EditTextfields>

            </MudCard>

            <MudCard Elevation="0">
                <EditDropdownMultiselect AlleFaciliteter="@alleFaciliteter" Model="@feriebolig" Overskrift="Faciliteter"></EditDropdownMultiselect>
            </MudCard>

        </MudPaper>
    </MudContainer>

    <MudContainer MaxWidth="MaxWidth.Small">

        <EditPriser Overskrift="Priser" Model="@feriebolig"></EditPriser>
        <!--TODO: lav lodtrækning og booking? måske kun booking??-->

        <MudCard Elevation="0">
            <BookingFeriebolig Model="@feriebolig"></BookingFeriebolig>
        </MudCard>

        <MudCard Elevation="0">
            <p class="feriebolig__overskrift">Bookinger</p>
            @foreach (var booking in feriebolig.Bookinger)
            {
                <p>@booking.Id: @booking.UdlejDato.ToString("dddd", inf) @booking.UdlejDato.ToShortDateString() - @booking.UdlejDato.ToString("dddd", inf) @booking.AfrejseDato.ToShortDateString()</p>
            }
        </MudCard>

        <MudCard Elevation="0">
            <EditNoegler Model="feriebolig"></EditNoegler>
        </MudCard>
    </MudContainer>


    <MudContainer MaxWidth="MaxWidth.Small">

        @foreach (var item in _sourceDocuments)
        {
            <a href="@item">pdf</a>
        }

        <Microsoft.AspNetCore.Components.Forms.InputFile multiple OnChange="HandlePdfSelected" accept=".pdf">

        </Microsoft.AspNetCore.Components.Forms.InputFile>

        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="UploadDocumentsAsync">Upload pdf</MudButton>
    </MudContainer>
</MudPaper>

@code {
    [Parameter]
    public int Id { get; set; }

    IList<IBrowserFile> files = new List<IBrowserFile>();
    Feriebolig feriebolig = new Feriebolig();
    List<Facilitet> faciliteter = new List<Facilitet>();
    public List<byte[]> ImageUploads = new List<byte[]>();
    public List<byte[]> DocumentUploads = new List<byte[]>();


    public List<Facilitet> alleFaciliteter = new List<Facilitet>();
    public readonly string[] FILTYPER = new[] { "image/jpg", "image/jpeg", "image/png" };
    CultureInfo inf = new CultureInfo("da-DK");
    private MudCarousel<string> _carousel = new MudCarousel<string>();
    private bool _arrows = true;
    private bool _delimiters = true;
    private bool _autocycle = false;
    private bool upload = false;
    private bool uploadFiltype = false;
    private string fejlbesked; 
    private IList<string> _source = new List<string>();

    private IList<string> _sourceDocuments = new List<string>();


    protected override async Task OnInitializedAsync()
    {
        alleFaciliteter = await facilitetService.GetFacilitiesAsync();
        feriebolig = await ferieboligService.GetFerieboligByIdAsync(Id);
        faciliteter = feriebolig.Faciliteter.ToList();

        @foreach (var file in feriebolig.Filer)
        {
            if (file.Type == FiloplysningType.Image)
            {
                _source.Add(helperService.convertImageToDisplay(file.Data));
            }
            else if (file.Type == FiloplysningType.Document)
            {
               // _sourceDocuments.Add(helperService.convertToPdf(file.Data));
            }
        }

        if (_carousel.Items.Count() > 0)
        {
            _carousel.MoveTo(0);
        }
    }


    private async Task HandlePdfSelected(InputFileChangeEventArgs e)
    {

        foreach (var item in e.GetMultipleFiles())
        {
            if (item.ContentType == "application/pdf")
            {
                try
                {
                    var ms = new MemoryStream();
                    await item.OpenReadStream(5242880).CopyToAsync(ms);
                    DocumentUploads.Add(ms.ToArray());
                }
                catch (Exception ex)
                {
                    throw new Exception(ex.Message);
                }
            }
            else
            {
                throw new InvalidDataException();
            }
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        upload = true;
        uploadFiltype = false;
        ImageUploads.Clear();
        files.Clear();

        foreach (var item in e.GetMultipleFiles())
        {
            if (FILTYPER.Contains(item.ContentType))
            {
                try
                {
                    var ms = new MemoryStream();
                    await item.OpenReadStream(5242880).CopyToAsync(ms);
                    ImageUploads.Add(ms.ToArray());
                    files.Add(item);
                }
                catch (Exception ex)
                {
                    uploadFiltype = true;
                    upload = false;
                    fejlbesked = "Filen må maks fylde 5 MB";
                    throw new Exception(ex.Message);
                }

            }
            else
            {
                upload = false;
                uploadFiltype = true;
                fejlbesked = "Filtype ikke understøttet. Understøttede filtyper: .jpg, .jpeg og .png";
            }
        }
    }

    private async Task UploadImages()
    {
        foreach (var imgUpload in ImageUploads)
        {
            //Upload til database
            Filoplysning filoplysning = new Filoplysning();
            filoplysning.Data = imgUpload;
            filoplysning.Name = Path.GetRandomFileName();
            filoplysning.FerieboligId = feriebolig.Id;
            await filoplysningerService.UploadFile(filoplysning);

            //Tilføj til vores karrusel
            _source.Add(helperService.convertImageToDisplay(filoplysning.Data));
            await Task.Delay(1);
            if(_carousel.Items.Count() > 0)
            {
                _carousel.MoveTo(_source.Count - 1);
            }

        }

        upload = false;
        ImageUploads.Clear();
        files.Clear();
    }


    private async Task UploadDocumentsAsync()
    {
        foreach (var document in DocumentUploads)
        {
            Filoplysning filoplysning = new Filoplysning();
            filoplysning.Data = document;
            filoplysning.Name = Path.GetRandomFileName();
            filoplysning.FerieboligId = feriebolig.Id;
            filoplysning.Type = FiloplysningType.Document;
            await filoplysningerService.UploadFile(filoplysning);

        }
    }



    private async Task DeleteAsync(int index)
    {
        if (_source.Any())
        {
            List<Filoplysning>
            filoplysninger = new List<Filoplysning>();
            filoplysninger = feriebolig.Filer.ToList();
            _source.RemoveAt(index);
            await Task.Delay(1);
            _carousel.MoveTo(System.Math.Max(System.Math.Min(index, _source.Count - 1), 0));
            await filoplysningerService.DeleteImageByIdAsync(filoplysninger.ElementAt(index).Id);

        }

    }

    }
