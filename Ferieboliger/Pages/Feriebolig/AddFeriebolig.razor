@using Ferieboliger.BLL.Services;
@using Ferieboliger.DAL.Models.Enums;
@using System.IO;
@using System;
@using Microsoft.AspNetCore.Components.Forms;
@using BlazorInputFile; 

@inject ISnackbar Snackbar
@inject IFerieboligService ferieboligService;
@inject IFacilitetService facilitetService;
@inject IFiloplysningerService filoplysningService;

<EditForm Model="@feriebolig" OnValidSubmit="GemFeriebolig">
    <DataAnnotationsValidator />
    <MudCard Elevation="0" Class="d-flex flex-column tilfoejFeriebolig__kategori">
        <MudTextField @bind-Value="feriebolig.Adresse.Vej" Label="Gade og husnummer" Variant="Variant.Text"></MudTextField>
        <MudCard Elevation="0" Class="d-flex tilfoejFeriebolig__fieldset">
            <MudTextField @bind-Value="feriebolig.Adresse.Postnummer" Label="Postnummer" Variant="Variant.Text"></MudTextField>
            <MudTextField @bind-Value="feriebolig.Adresse.By" Label="By" Variant="Variant.Text"></MudTextField>
        </MudCard>
        <MudTextField @bind-Value="feriebolig.Adresse.Land" Label="Land" Variant="Variant.Text"></MudTextField>
    </MudCard>

    <MudCard Elevation="0" Class="tilfoejFeriebolig__kategori">
        <MudCard Elevation="0" Class="d-flex tilfoejFeriebolig__fieldset">
            <MudNumericField @bind-Value="feriebolig.PrisHoej" Label="Pris - højsæson" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="DKK" HideSpinButtons="true" />
            <MudNumericField @bind-Value="feriebolig.PrisLav" Label="Pris - lavsæson" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="DKK" HideSpinButtons="true" />
        </MudCard>
        <MudCard Elevation="0" Class="d-flex tilfoejFeriebolig__fieldset">
            <MudNumericField @bind-Value="feriebolig.BeskatningHoej" Label="Beskatning - højsæson" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="DKK" HideSpinButtons="true" />
            <MudNumericField @bind-Value="feriebolig.BeskatningLav" Label="Beskatning - lavsæson" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="DKK" HideSpinButtons="true" />
        </MudCard>
    </MudCard>


    <MudSelect Label="Ferieboligtype" @bind-Value="feriebolig.Type">
        @foreach (FerieboligType item in Enum.GetValues(typeof(FerieboligType)))
        {
            <MudSelectItem Value="@item">@item</MudSelectItem>
        }
    </MudSelect>
    <MudCard Elevation="0" Class="d-flex tilfoejFeriebolig__fieldset tilfoejFeriebolig__kategori">
        <MudTimePicker Label="Ankomsttidspunkt" @bind-Time="feriebolig.AnkomstTidspunkt" TimeEditMode="TimeEditMode.Normal" />
        <MudTimePicker Label="Afgangstidspunkt" @bind-Time="feriebolig.AfgangTidspunkt" TimeEditMode="TimeEditMode.Normal" />
    </MudCard>
    <MudCard Elevation="0" Class="d-flex flex-column tilfoejFeriebolig__kategori">
        <MudNumericField @bind-Value="feriebolig.NoeglerTilgaengelig" Label="Antal nøgler" Variant="Variant.Text" Min="0" Max="10" />
        <MudCheckBox @bind-Checked="@feriebolig.SendNoegler" Label="Nøgler skal tilsendes"></MudCheckBox>
    </MudCard>

    <MudCard Elevation="0" Class="tilfoejFeriebolig__kategori">
        <MudNumericField @bind-Value="feriebolig.AntalBadevaerelser" Label="Antal badeværelser" Variant="Variant.Text" Min="0" Max="10" />
        <MudNumericField @bind-Value="feriebolig.AntalSovepladser" Label="Antal sovepladser" Variant="Variant.Text" Min="0" Max="10" />
        <MudNumericField @bind-Value="feriebolig.AntalPersoner" Label="Antal personer" Variant="Variant.Text" Min="0" Max="50" />
    </MudCard>

    <MudCard Elevation="0" Class="d-flex tilfoejFeriebolig__fieldset tilfoejFeriebolig__kategori">
        <MudCheckBox @bind-Checked="@feriebolig.HusdyrTilladt" Label="Husdyr tilladt"></MudCheckBox>
        @if (feriebolig.HusdyrTilladt)
        {
            <MudNumericField @bind-Value="feriebolig.AntalHusdyr" Label="Antal husdyr" Variant="Variant.Text" Min="0" Max="50" />
        }

    </MudCard>
    <MudCard Elevation="0" Class="tilfoejFeriebolig__kategori">
        <MudNumericField @bind-Value="feriebolig.AntalKvadratmeter" Label="Boligareal" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="m2" HideSpinButtons="true" />
        <MudNumericField @bind-Value="feriebolig.Grundareal" Label="Grundareal" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="m2" HideSpinButtons="true" />
        <MudNumericField @bind-Value="feriebolig.AfstandIndkoeb" Label="Afstand til indkøb" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="m" HideSpinButtons="true" />
        <MudNumericField @bind-Value="feriebolig.AfstandStrand" Label="Afstand til strand" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="m" HideSpinButtons="true" />
        <MudNumericField @bind-Value="feriebolig.AfstandRestaurant" Label="Afstand til spisested" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="m" HideSpinButtons="true" />
    </MudCard>

    <MudCard Elevation="0" Class="tilfoejFeriebolig__kategori">
        <MudSelect T="Facilitet" Label="Faciliteter" MultiSelection="true" @bind-SelectedValues="options">
            @foreach (var facilitet in faciliteter)
            {
                //TODO den skal vises pænt i oversigt - ikke DAL halløj
                <MudSelectItem T="Facilitet" Value="@facilitet">@facilitet.Beskrivelse</MudSelectItem>
            }
        </MudSelect>
    </MudCard>


    <MudCard Elevation="0" Class="tilfoejFeriebolig__kategori">
        <MudTextField T="string" Label="Beskrivelse" Variant="Variant.Text" @bind-Value="feriebolig.Beskrivelse" Lines="3" />
        <MudTextField T="string" Label="Bemærkninger" Variant="Variant.Text" @bind-Value="feriebolig.Bemaerkninger" Lines="3" />
    </MudCard>

    <Microsoft.AspNetCore.Components.Forms.InputFile id="uploadFiles" multiple hidden OnChange="HandleFileSelected" MaxBufferSize="@(20*1024)"></Microsoft.AspNetCore.Components.Forms.InputFile>
    <MudButton HtmlTag="label"
               Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Filled.CloudUpload"
               for="uploadFiles">
        Tilføj billeder
    </MudButton>

    @if (files != null)
    {
        <MudText Typo="@Typo.h6">@files.Count() File@(files.Count() == 1 ? "" : "s"):</MudText>
        <MudList>
            @foreach (var file in files)
            {
                <MudListItem Icon="@Icons.Filled.AttachFile" @key="@file">
                    @file.Name <code>@file.Size bytes</code>
                </MudListItem>
            }
        </MudList>
    }


    <MudCardActions Class="justify-end">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit">Gem</MudButton>
    </MudCardActions>





</EditForm>

@if (gemt)
{
    <MudText>Feriebolig gemt</MudText>
}


@code {


    Feriebolig feriebolig = new Feriebolig() { Filer = new List<Filoplysning>() };

    public List<byte[]> ImageUploads = new List<byte[]>();
    IList<IBrowserFile> files = new List<IBrowserFile>();

    public bool gemt = false;
    TimeSpan? time = new TimeSpan(00, 45, 00);
    public List<Facilitet> faciliteter = new List<Facilitet>();

    private HashSet<Facilitet> options { get; set; } = new HashSet<Facilitet>();

    protected override async Task OnInitializedAsync()
    {
        faciliteter = await facilitetService.GetFacilitiesAsync();
    }

    public async Task GemFeriebolig()
    {
        feriebolig.Faciliteter = options.ToList();

        await ferieboligService.AddFerieboligAsync(feriebolig);

        foreach (var imgUpload in ImageUploads)
        {
            Filoplysning filoplysning = new Filoplysning();

            //filoplysning.Id = 0;
            filoplysning.Data = imgUpload;
            filoplysning.Name = Path.GetRandomFileName();
            filoplysning.FerieboligId = feriebolig.Id;
            await filoplysningService.UploadImage(filoplysning);
        }

        gemt = true;
    }



    async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        foreach (var item in e.GetMultipleFiles())
        {
            var ms = new MemoryStream();
            await item.OpenReadStream().CopyToAsync(ms);
            ImageUploads.Add(ms.ToArray());
            files.Add(item);
        }
    }



}
